{% extends 'accounting/base.html' %}

{% block content %}
    <h1>Create Invoice</h1>
    <form action="{% url 'create_invoice' %}" method="POST">
        {% csrf_token %}
        
        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Customer</label>
                        <select name="customer" class="form-select" required>
                            <option value="" disabled selected>-- Select Customer --</option>
                            {% for c in customers %}<option value="{{ c.id }}">{{ c.name }}</option>{% endfor %}
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-bold">Project (Optional)</label>
                        <select name="project" class="form-select">
                            <option value="">-- No Project --</option>
                            {% for p in projects %}
                                <option value="{{ p.id }}">{{ p.code }} - {{ p.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-4 text-end">
                        <h5 class="text-muted">INVOICE NO. <span class="text-dark">AUTO</span></h5>
                    </div>
                </div>

                <hr>

                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Terms</label>
                        <select name="payment_terms" id="payment_terms" class="form-select" onchange="calculateDueDate()">
                            <option value="Due on Receipt">Due on Receipt</option>
                            <option value="Net 15">Net 15</option>
                            <option value="Net 30">Net 30</option>
                            <option value="Net 60">Net 60</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Invoice Date</label>
                        <input type="date" name="invoice_date" id="invoice_date" class="form-control" required onchange="calculateDueDate()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Due Date</label>
                        <input type="date" name="due_date" id="due_date" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Description</label>
                        <input type="text" name="description" class="form-control" placeholder="Summary...">
                    </div>
                </div>
            </div>
        </div>

        <table class="table border" id="inv-lines-table">
            <thead class="table-light">
                <tr>
                    <th style="width: 25%;">Product / Service</th>
                    <th style="width: 25%;">Income Account</th>
                    <th style="width: 15%;">Quantity</th>
                    <th style="width: 15%;">Rate</th>
                    <th>Amount</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="inv-lines-body">
                <tr>
                    <td>
                        <select name="product" class="form-select product-select" onchange="updatePrice(this)" required>
                            <option value="" disabled selected>-- Select Product --</option>
                            {% for p in products %}
                                <option value="{{ p.id }}" data-price="{{ p.unit_price }}" data-account="{{ p.revenue_account.id }}">
                                    {{ p.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>

                    <td>
                        <select name="account" class="form-select account-select" required>
                            {% for acc in revenue_accounts %}
                                <option value="{{ acc.id }}">{{ acc.account_name }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    
                    <td><input type="number" step="0.01" name="quantity" class="form-control qty" oninput="calculateRow(this)"></td>
                    <td><input type="number" step="0.01" name="unit_price" class="form-control price" oninput="calculateRow(this)"></td>
                    <td><input type="text" class="form-control row-total" readonly></td>
                    <td><button type="button" class="btn btn-outline-danger btn-sm border-0" onclick="removeRow(this)">âœ–</button></td>
                </tr>
            </tbody>
        </table>
        
        <button type="button" class="btn btn-outline-secondary mb-4" onclick="addRow()">+ Add line</button>

        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label fw-bold">Message on invoice</label>
                    <textarea name="customer_message" class="form-control" rows="3"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold text-muted">Internal notes</label>
                    <textarea name="internal_notes" class="form-control" rows="2"></textarea>
                </div>
            </div>
            <div class="col-md-4 offset-md-2">
                <table class="table table-borderless">
                    <tr class="border-top">
                        <td class="fs-4 fw-bold">Total</td>
                        <td class="fs-4 fw-bold text-end" id="grand-total">$0.00</td>
                    </tr>
                </table>
            </div>
        </div>

        <hr>
        <div class="d-flex justify-content-end">
            <a href="{% url 'invoice_list' %}" class="btn btn-light me-2">Cancel</a>
            <button type="submit" class="btn btn-success px-4">Save and Send</button>
        </div>
    </form>

    <script>
        const today = new Date();
        document.getElementById('invoice_date').valueAsDate = today;
        calculateDueDate();

        function addRow() {
            const tbody = document.getElementById("inv-lines-body");
            const newRow = tbody.firstElementChild.cloneNode(true);
            newRow.querySelectorAll("input").forEach(input => input.value = "");
            newRow.querySelector("select").selectedIndex = 0;
            newRow.querySelector(".row-total").value = "";
            tbody.appendChild(newRow);
        }

        function removeRow(btn) {
            if (document.querySelectorAll("#inv-lines-body tr").length > 1) {
                btn.closest("tr").remove();
                calculateGrandTotal();
            } else {
                alert("You must have at least one line item.");
            }
        }

        function updatePrice(selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const price = selectedOption.getAttribute('data-price');
            const accountId = selectedOption.getAttribute('data-account');
            
            const row = selectElement.closest('tr');
            
            if (price) {
                const priceInput = row.querySelector('.price');
                priceInput.value = price;
                const qtyInput = row.querySelector('.qty');
                if (!qtyInput.value) qtyInput.value = 1;
                calculateRow(priceInput);
            }
            if (accountId) {
                const accSelect = row.querySelector('.account-select');
                accSelect.value = accountId;
            }
        }

        function calculateRow(input) {
            const row = input.closest("tr");
            const qty = parseFloat(row.querySelector(".qty").value) || 0;
            const price = parseFloat(row.querySelector(".price").value) || 0;
            row.querySelector(".row-total").value = (qty * price).toFixed(2);
            calculateGrandTotal();
        }

        function calculateGrandTotal() {
            let total = 0;
            document.querySelectorAll(".row-total").forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            document.getElementById("grand-total").textContent = "$" + total.toFixed(2);
        }

        function calculateDueDate() {
            const dateInput = document.getElementById('invoice_date').value;
            const terms = document.getElementById('payment_terms').value;
            if (!dateInput) return;
            
            const parts = dateInput.split('-');
            const date = new Date(parts[0], parts[1] - 1, parts[2]);
            
            let daysToAdd = 0;
            if (terms === 'Net 15') daysToAdd = 15;
            else if (terms === 'Net 30') daysToAdd = 30;
            else if (terms === 'Net 60') daysToAdd = 60;

            date.setDate(date.getDate() + daysToAdd);
            
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            document.getElementById('due_date').value = `${yyyy}-${mm}-${dd}`;
        }
    </script>
{% endblock %}