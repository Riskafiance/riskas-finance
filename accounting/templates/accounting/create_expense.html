{% extends 'accounting/base.html' %}

{% block content %}
    <h1>Record Expense</h1>
    <form action="{% url 'create_expense' %}" method="POST">
        {% csrf_token %}
        
        <div class="row mb-3">
            <div class="col-md-3">
                <label class="form-label">Date</label>
                <input type="date" name="expense_date" class="form-control" required>
            </div>
            <div class="col-md-4">
                <label class="form-label">Vendor</label>
                <select name="vendor" id="id_vendor" class="form-select" required>
                    <option value="" disabled selected>-- Select Vendor --</option>
                    {% for v in vendors %}<option value="{{ v.id }}">{{ v.name }}</option>{% endfor %}
                </select>
            </div>
            
            <div class="col-md-3">
                <label class="form-label">Project (Optional)</label>
                <select name="project" class="form-select">
                    <option value="">-- No Project --</option>
                    {% for p in projects %}
                        <option value="{{ p.id }}">{{ p.code }} - {{ p.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2">
                <label class="form-label">Link to PO</label>
                <select name="purchase_order" class="form-select">
                    <option value="">-- None --</option>
                    {% for po in open_pos %}
                        <option value="{{ po.id }}">{{ po.po_number }} (${{ po.total_amount }})</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-5">
                <label class="form-label">Pay From Account (Bank/Cash)</label>
                <select name="payment_account" class="form-select" required>
                    {% for acc in payment_accounts %}<option value="{{ acc.id }}">{{ acc.account_number }} - {{ acc.account_name }}</option>{% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Reference #</label>
                <input type="text" name="reference_number" class="form-control" placeholder="e.g. Check 101">
            </div>
            <div class="col-md-4">
                <label class="form-label">Description</label>
                <input type="text" name="description" class="form-control" placeholder="What was this for?">
            </div>
        </div>

        <h4 class="mt-4">Expense Categories</h4>
        <table class="table" id="exp-lines-table">
            <thead class="table-light">
                <tr>
                    <th style="width: 40%;">Category (Expense Account)</th>
                    <th style="width: 30%;">Description</th>
                    <th style="width: 20%;">Amount</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="exp-lines-body">
                <tr>
                    <td>
                        <select name="account" class="form-select category-select" required>
                            <option value="" disabled selected>-- Select Account --</option>
                            {% for acc in expense_accounts %}<option value="{{ acc.id }}">{{ acc.account_number }} - {{ acc.account_name }}</option>{% endfor %}
                        </select>
                    </td>
                    <td><input type="text" name="line_description" class="form-control"></td>
                    <td><input type="number" step="0.01" name="amount" class="form-control amt" oninput="calculateTotal()"></td>
                    <td><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">X</button></td>
                </tr>
            </tbody>
            <tfoot>
                <tr class="fw-bold">
                    <td colspan="2" class="text-end">Total Paid:</td>
                    <td id="grand-total">$0.00</td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
        <button type="button" class="btn btn-secondary" onclick="addRow()">Add Line</button>
        <hr>
        <div class="d-flex justify-content-end">
            <a href="{% url 'expense_list' %}" class="btn btn-light me-2">Cancel</a>
            <button type="submit" class="btn btn-success px-4">Save & Post Expense</button>
        </div>
    </form>

    <script>
        // --- STANDARD TABLE LOGIC ---
        function addRow() {
            const tbody = document.getElementById("exp-lines-body");
            const newRow = tbody.firstElementChild.cloneNode(true);
            newRow.querySelectorAll("input").forEach(input => input.value = "");
            newRow.querySelector("select").selectedIndex = 0;
            newRow.querySelector("select").style.backgroundColor = ""; 
            tbody.appendChild(newRow);
        }

        function removeRow(btn) {
            if (document.querySelectorAll("#exp-lines-body tr").length > 1) {
                btn.closest("tr").remove();
                calculateTotal();
            }
        }

        function calculateTotal() {
            let total = 0;
            document.querySelectorAll(".amt").forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            document.getElementById("grand-total").textContent = "$" + total.toFixed(2);
        }

        // --- AI SMART CATEGORIZATION LOGIC ---
        const vendorSelect = document.getElementById('id_vendor');
        
        vendorSelect.addEventListener('change', function() {
            const vendorId = this.value;
            
            fetch(`/api/predict-account/?vendor_id=${vendorId}`)
            .then(response => response.json())
            .then(data => {
                if (data.suggested_account_id) {
                    const firstAccountSelect = document.querySelector('.category-select');
                    firstAccountSelect.value = data.suggested_account_id;
                    
                    const originalColor = firstAccountSelect.style.backgroundColor;
                    firstAccountSelect.style.transition = "background-color 0.5s";
                    firstAccountSelect.style.backgroundColor = "#fff3cd"; // Light yellow flash
                    
                    setTimeout(() => {
                        firstAccountSelect.style.backgroundColor = originalColor;
                    }, 1500);
                }
            })
            .catch(error => console.error('AI Prediction Error:', error));
        });
    </script>
{% endblock %}